<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Roboto+Serif:wght@400;500;600&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">
  <title>Bihar Assembly | Constituency Viewer</title>
  <style>
    :root {
      --bg: #FFFFFF;
      --card: #FFFFFF;
      --text: #000000;
      --muted: #5B6064;
      --border: #E5E7EB;
      --primary: #0EA5E9;
      --primary-dark: #0284C7;
      --header-bg: #0EA5E9; --header-text: #FFFFFF;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.06);
      --shadow-md: 0 8px 24px rgba(0,0,0,0.06);
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font: 16px/1.5 'Roboto Slab', 'Roboto Serif', Georgia, serif; background: var(--bg); color: var(--text); }
    .container { max-width: 1120px; margin: 0 auto; padding: 0 16px; }
    
    /* Header Styles */
    .main-header { display: none !important; }
    .header-content { max-width: 1120px; margin: 0 auto; padding: 0 16px; display: flex; justify-content: space-between; align-items: center; }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .header-right { display: flex; align-items: center; gap: 16px; }
    .menu-icon, .search-icon, .account-icon { cursor: pointer; font-size: 18px; }
    .site-title { font-size: 18px; font-weight: 600; margin: 0; letter-spacing: 0.5px; }
    
    /* Search Section */
    .search-section { padding: 24px 0 16px; }
    .search-controls { display: flex; gap: 12px; align-items: center; margin-bottom: 8px; flex-wrap: wrap; }
    .search-controls label { font-weight: 500; color: var(--text); }
    input[type="number"] { padding: 12px 16px; border: 1px solid var(--border); border-radius: 10px; width: 260px; font-size: 16px; min-height: 48px; background: #fff; }
    input[type="number"]::placeholder { color: var(--muted); opacity: 1; }
    input[type="number"]:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(0, 145, 172, 0.1); }
    .primary-btn { padding: 12px 20px; border: none; border-radius: 10px; background: var(--primary); color: #fff; cursor: pointer; font-size: 16px; font-weight: 600; min-height: 48px; }
    .primary-btn:hover { background: var(--primary-dark); }
    .helper-text { color: #999999; font-size: 16px; margin-bottom: 8px; font-family: 'Roboto Slab', serif; }
    .status-text { color: var(--muted); font-size: 14px; }
    /* Mobile-first Card Layout */
    .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
    .constituency-header { margin-bottom: 24px; }
    .constituency-title { font-family: 'Playfair Display', serif; font-size: 44px; font-weight: 700; margin: 0 0 8px; color: var(--text); line-height: 1.1; }
    .constituency-info { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
    .current-mla-card { margin-bottom: 16px; }
    .current-mla-title {
      font-family: 'Roboto Slab', serif;
      font-size: 16px;
      font-weight: 400;
      line-height: 21px;
      color: #000;
      letter-spacing: 0;
      margin: 0 0 6px;
    }
    .mla-name {
      font-family: 'Roboto Slab', serif;
      font-size: 16px;
      font-weight: 400;
      line-height: 21px;
      color: #000;
      margin: 0;
    }
    .mla-party { color: var(--muted); font-size: 14px; }
    .mla-alliance { color: var(--muted); font-size: 14px; margin-top: 2px; }
    .current-mla-meta {
      font-family: 'Roboto Slab', serif;
      font-size: 14px;
      line-height: 18px;
      color: #5B6064;
      margin: 4px 0 0;
    }
    
    /* CMS Content Placeholder */
    .cms-content-card { margin-bottom: 16px; }
    .cms-content-title { font-size: 16px; font-weight: 600; margin: 0 0 12px; letter-spacing: 0.5px; color: var(--text); }
    .cms-content-body { color: var(--text); line-height: 1.6; font-size: 15px; }
    .cms-placeholder { color: var(--muted); font-style: italic; background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px dashed var(--border); }
    .map-section-title { font-family: 'Playfair Display', serif; font-size: 32px; font-weight: 600; margin: 0 0 6px; color: #000; line-height: 1.15; }
    .map-helper { color: #000; font-size: 16px; margin: 0 0 12px; font-family: 'Roboto Slab', serif; }
    /* Figma-aligned section titles */
    .past-results-title { font-family: 'Playfair Display', serif; font-size: 32px; font-weight: 600; line-height: 36px; margin: 0 0 12px; color: #000; }
    
    /* Mobile-first: Stack everything vertically */
    .results-container { display: flex; flex-direction: column; gap: 16px; }
    .muted { color: var(--muted); }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef2ff; border: 1px solid #e5e7eb; font-size: 12px; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; color: #fff; font-size: 12px; }
    .kv { display: grid; grid-template-columns: 140px 1fr; gap: 6px 12px; }
    .section-title { font-weight: 600; margin: 0 0 8px; }
    .vote-bars { margin-top: 8px; }
    .bar { height: 8px; border-radius: 999px; background: #e5e7eb; position: relative; margin-bottom: 6px; }
    .bar > span { position: absolute; left: 0; top: 0; bottom: 0; border-radius: 999px; }
    .bar-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .hr { height: 1px; background: var(--border); margin: 12px 0; }
    .note { font-size: 12px; color: var(--muted); }
    .error { color: #b91c1c; }
    
    /* Data Source Disclaimer Footer */
    .disclaimer-footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
      text-align: center;
    }
    .disclaimer-text {
      color: var(--muted);
      font-size: 11px;
      line-height: 1.4;
      font-weight: 400;
    }
    
    /* Horizontal Timeline */
    .trends-container { margin: 20px 0; }
    .timeline-scroll {
      overflow-x: auto;
      padding: 20px 0;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }
    .timeline-container {
      display: flex;
      align-items: center;
      min-width: max-content;
      padding: 0 20px;
      gap: 0;
      position: relative;
    }
    .timeline-year {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      min-width: 120px;
      padding: 0 10px;
    }
    .timeline-year-badge {
      background: var(--primary);
      color: white;
      font-weight: 700;
      font-size: 16px;
      padding: 8px 16px;
      border-radius: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 145, 172, 0.3);
      position: relative;
      z-index: 2;
    }
    .timeline-candidate {
      text-align: center;
      margin-bottom: 8px;
    }
    .timeline-candidate-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--text);
      margin-bottom: 4px;
    }
    .timeline-party {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      color: white;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    .timeline-connection {
      display: flex;
      align-items: center;
      flex-direction: column;
      min-width: 100px;
      position: relative;
    }
    .timeline-line {
      width: 60px;
      height: 3px;
      background: var(--border);
      position: relative;
      margin: 10px 0;
    }
    .timeline-line::before {
      content: '';
      position: absolute;
      top: 50%;
      right: -4px;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid var(--border);
      border-top: 4px solid transparent;
      border-bottom: 4px solid transparent;
    }
    .timeline-change {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 8px;
    }
    .timeline-hold {
      background: #dcfce7;
      color: #16a34a;
    }
    .timeline-gain {
      background: #fef3c7;
      color: #d97706;
    }
    .timeline-hint {
      display: none; /* Hidden by default on desktop */
      text-align: center;
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
      margin-bottom: 4px;
      font-style: italic;
    }

    /* Election Result Cards */
    .election-result { margin-bottom: 16px; }
    .election-title { font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 600; line-height: 36px; margin: 0 0 12px; color: var(--text); }
    .candidate-row { margin-bottom: 16px; }
    .candidate-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .candidate-name { font-family: 'Roboto Slab', serif; font-weight: 700; font-size: 16px; }
    .candidate-party { color: var(--muted); font-size: 14px; }
    .vote-count { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-weight: 600; }
    .margin-info { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
    .margin-text { font-family: 'Roboto Slab', serif; font-weight: 700; font-size: 12px; }
    
    /* Mobile Timeline Optimizations */
    @media (max-width: 767px) {
      .timeline-scroll {
        padding: 16px 0;
        scroll-snap-type: x mandatory;
      }
      .timeline-container {
        padding: 0 16px;
      }
      .timeline-year {
        min-width: 100px;
        padding: 0 8px;
        scroll-snap-align: center;
      }
      .timeline-year-badge {
        font-size: 14px;
        padding: 6px 12px;
        margin-bottom: 12px;
      }
      .timeline-candidate-name {
        font-size: 12px;
      }
      .timeline-party {
        font-size: 11px;
        padding: 3px 8px;
      }
      .timeline-connection {
        min-width: 80px;
      }
      .timeline-line {
        width: 50px;
      }
      .timeline-change {
        font-size: 10px;
        padding: 3px 6px;
      }
      .timeline-hint {
        display: block; /* Show on mobile */
      }
    }

    /* Responsive Breakpoints */
    @media (min-width: 768px) {
      .container { padding: 0 24px; }
      .search-controls { gap: 16px; }
      .results-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
      .constituency-title { font-size: 28px; }
    }
    
    @media (min-width: 1024px) {
      .results-container { grid-template-columns: 1fr 1fr 1fr; }
      .header-content { padding: 0 24px; }
      .constituency-title { font-size: 32px; }
    }
  </style>
</head>
<body>
  <header class="main-header">
    <div class="header-content">
      <div class="header-left">
        <span class="menu-icon">☰</span>
        <h1 class="site-title">BIHAR ASSEMBLY</h1>
      </div>
      <div class="header-right">
        <span class="search-icon">🔍</span>
        <span class="account-icon">👤</span>
      </div>
    </div>
  </header>
  
  <div class="container">
    <div class="search-section">
      <div class="search-controls">
        <label for="seatNo">Constituency No:</label>
        <input id="seatNo" type="number" min="1" max="243" placeholder="e.g. 21" />
        <button id="loadBtn" class="primary-btn">Load</button>
        <button id="exportBtn" class="primary-btn" style="background:#10b981" disabled>Export Embed</button>
        <label style="margin-left:12px; display:flex; align-items:center; gap:6px;">
          <input id="resultsToggle" type="checkbox" disabled />
          <span>Results announced (auto)</span>
        </label>
        <label style="margin-left:12px; display:flex; align-items:center; gap:6px;">
          <input id="sourceToggle" type="checkbox" />
          <span>Use local bundled data</span>
        </label>
      </div>
      <div class="helper-text">Search constituency by number, name, or district. Page auto-detects 2025 results from data.</div>
      <span id="status" class="status-text"></span>
      <div class="note">Tip: Serve this file over a local web server to allow fetching local JSON (e.g., <span class="mono">python -m http.server</span> and open http://localhost:8000/constituency_viewer.html).</div>
    </div>

    <div id="output"></div>
    <div class="note" style="margin-top:12px;">
      This page incorporates information from Wikipedia articles, available under the Creative Commons Attribution-ShareAlike 4.0 License
    </div>
  </div>

  <script>
    // Inline CMS content blocks (hardcoded)
    const CMS_PRE_HTML = `
      <p>The Bihar Assembly elections are underway. Follow this page for constituency-wise context, key candidates, and background ahead of the 2025 results. We’ll update this section with quick takeaways as trends emerge.</p>
      <p>Note: Past results and party colors are based on publicly available records. Turn the ‘Results announced’ toggle on when official 2025 results are declared to see updated summaries.</p>
    `;
    const CMS_POST_HTML = `
      <p>The 2025 results for this constituency are in. The summary and margin details are displayed above. Use this section for quick context on how the outcome compares with 2010–2020 and what it means for the broader alliances.</p>
      <p>Data sources include official ECI releases and curated archives. We will refine the summary as more granular booth-level data is published.</p>
    `;
    function detectDataSource(){
      try {
        const qp = new URLSearchParams(location.search);
        const forced = (qp.get('source') || '').toLowerCase();
        if (forced === 'sandbox') return 'sandbox';
        if (forced === 'gh' || forced === 'github') return 'github';
      } catch {}
      const host = (location.hostname || '').toLowerCase();
      if (host.includes('quintype.io') || host.includes('sandbox')) return 'sandbox';
      return 'github';
    }

    function getFiles(useLocal){
      if (useLocal){
        return {
          parties: './parties.json',
          resultsConsolidated: './bihar_election_results_consolidated.json',
          alliances: './alliances.json',
        };
      }
      const src = detectDataSource();
      if (src === 'sandbox'){
        return {
          parties: 'https://dh-sandbox-web.quintype.io/parties.json',
          resultsConsolidated: 'https://dh-sandbox-web.quintype.io/bihar_election_results_consolidated',
          alliances: 'https://dh-sandbox-web.quintype.io/alliances.json',
        };
      }
      return {
        parties: 'https://suhastpml.github.io/Bihar_constituency_page/parties.json',
        resultsConsolidated: 'https://suhastpml.github.io/Bihar_constituency_page/bihar_election_results_consolidated.json',
        alliances: 'https://suhastpml.github.io/Bihar_constituency_page/alliances.json',
      };
    }

    const PARTY_NORMALIZE = new Map([
      ['JDU','JD(U)'], ['JD(U)','JD(U)'], ['CPM','CPI(M)'], ['HAM','HAM(S)'], ['Ind','IND'], ['IND','IND']
    ]);

    const fmtNumber = (n) => (n==null? 'N/A' : Number(n).toLocaleString('en-IN'));

    function normalizeParty(code){ if(!code) return code; const c = code.trim(); return PARTY_NORMALIZE.get(c) || c; }

    // Color utilities and dynamic alliance palette (aligned with map.html)
    function pastelizeColor(hex, mix = 0.25) {
      if (!hex || typeof hex !== 'string') return '#e5e7eb';
      const normalized = hex.replace('#', '').trim();
      if (!normalized || normalized.length !== 6 || /[^0-9a-f]/i.test(normalized)) return '#e5e7eb';
      const r = parseInt(normalized.slice(0, 2), 16);
      const g = parseInt(normalized.slice(2, 4), 16);
      const b = parseInt(normalized.slice(4, 6), 16);
      const blend = (c) => Math.round(c + (255 - c) * mix);
      const toHex = (v) => v.toString(16).padStart(2, '0');
      return '#' + toHex(blend(r)) + toHex(blend(g)) + toHex(blend(b));
    }

    function normalizeAllianceKey(a){ return (a == null) ? null : String(a).trim().toUpperCase(); }
    function isValidHexColor(hex){ if(!hex || typeof hex !== 'string') return false; const h = hex.trim(); return /^#?[0-9a-fA-F]{6}$/.test(h); }
    function to6Hex(hex){ const h = hex.replace('#','').trim(); return '#' + h.toLowerCase(); }
    function deterministicColorFor(key){ let h=0, s=55, l=52; for(let i=0;i<key.length;i++){ h=((h<<5)-h)+key.charCodeAt(i); h|=0; } const hue=Math.abs(h)%360; const a=s/100*Math.min(l/100,1-l/100); const f=n=>{ const k=(n+hue/30)%12; const col=l/100 - a*Math.max(Math.min(k-3, 9-k, 1), -1); return Math.round(255*col).toString(16).padStart(2,'0'); }; return '#'+f(0)+f(8)+f(4); }
    function resolveAllianceForYear(party, year, partiesIdx){
      const info = partiesIdx[party] || partiesIdx[normalizeParty(party)] || null;
      if (!info) return 'NA';
      const alliances = info.alliances || null;
      const a = (alliances && (alliances[String(year)] || alliances[year]))
        || info[`alliance_${year}`]
        || info.alliance_2020
        || info.alliance
        || 'NA';
      return normalizeAllianceKey(a) || 'NA';
    }
    function buildAllianceColorsFromParties(parties, override){
      const pastel = new Map();
      const original = new Map();
      // 1) Apply explicit overrides from alliances.json
      if (override && typeof override === 'object'){
        for (const k in override){
          if (!Object.prototype.hasOwnProperty.call(override, k)) continue;
          const key = normalizeAllianceKey(k);
          const hex = to6Hex(String(override[k]||''));
          if (!key || !isValidHexColor(hex)) continue;
          original.set(key, hex);
          pastel.set(key, pastelizeColor(hex));
        }
      }
      // 2) Fill remaining labels from parties.json
      const candidates = new Map();
      const pushCandidate = (label, hex) => {
        const key = normalizeAllianceKey(label);
        if (!key || original.has(key)) return;
        const h = (hex || '').trim();
        if (!h) return;
        const hex6 = to6Hex(h);
        if (hex6 === '#ffffff' || !isValidHexColor(hex6)) return;
        if (!candidates.has(key)) candidates.set(key, []);
        candidates.get(key).push(hex6);
      };
      for (const p of (parties||[])){
        const ac = p.alliance_colour_code || p.alliance_color_code || p.alliance_colour || p.alliance_color || '';
        pushCandidate(p.alliance, ac);
        const almap = p.alliances || {};
        for (const y of Object.keys(almap)) pushCandidate(almap[y], ac);
      }
      for (const [ally, arr] of candidates){
        if (!arr.length) continue;
        const freq = new Map();
        for (const h of arr) freq.set(h, (freq.get(h)||0)+1);
        const chosen = Array.from(freq.entries()).sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0]))[0][0];
        original.set(ally, chosen);
        pastel.set(ally, pastelizeColor(chosen));
      }
      // 3) Seed NA if missing
      if (!original.has('NA')) { original.set('NA','#999999'); pastel.set('NA', pastelizeColor('#999999')); }
      return { allianceColors: pastel, allianceOriginalColors: original };
    }

    function parseCSV(text){
      // Robust-enough CSV parser supporting quoted fields and commas
      const rows = [];
      let i=0, field='', row=[], inQ=false; 
      function pushField(){ row.push(field); field=''; }
      function pushRow(){ rows.push(row); row=[]; }
      while(i<text.length){
        const ch = text[i];
        if (inQ){
          if (ch==='"' && text[i+1]==='"'){ field+='"'; i+=2; continue; }
          if (ch==='"'){ inQ=false; i++; continue; }
          field+=ch; i++; continue;
        } else {
          if (ch==='"'){ inQ=true; i++; continue; }
          if (ch===','){ pushField(); i++; continue; }
          if (ch==='\n'){ pushField(); pushRow(); i++; continue; }
          if (ch==='\r'){ i++; continue; }
          field+=ch; i++; continue;
        }
      }
      if (field.length>0 || row.length>0) { pushField(); pushRow(); }
      // Header map
      const header = rows.shift() || [];
      return rows.filter(r=>r.length>0 && r.some(c=>c.trim()!=='')).map(r=>{
        const o={}; header.forEach((h,idx)=>{ o[h]=r[idx]; }); return o;
      });
    }

    async function loadAll(){
      const status = document.getElementById('status');
      status.textContent = 'Loading data...';
      const useLocal = !!(document.getElementById('sourceToggle') && document.getElementById('sourceToggle').checked);
      const FILES = getFiles(useLocal);
      const [partiesRes, consolidatedRes] = await Promise.all([
        fetch(FILES.parties),
        fetch(FILES.resultsConsolidated)
      ]);
      const [parties, consolidated] = await Promise.all([
        partiesRes.json(), consolidatedRes.json()
      ]);
      // Try to load alliances.json (optional)
      let alliancesOverride = null;
      try {
        const aRes = await fetch(FILES.alliances);
        if (aRes && aRes.ok) alliancesOverride = await aRes.json();
      } catch(_){}
      status.textContent = 'Data loaded';

      // Indexes
      const partiesIdx = {}; (parties||[]).forEach(p=> partiesIdx[p.code]=p);
      // Build dynamic alliance palettes (for consistency with map.html)
      const { allianceColors, allianceOriginalColors } = buildAllianceColorsFromParties(parties||[], alliancesOverride || null);
      // Index consolidated by seat number
      const consolidatedByNo = new Map();
      if (Array.isArray(consolidated)){
        for (const row of consolidated){
          const no = parseInt(String(row.no||''),10);
          if (Number.isFinite(no)) consolidatedByNo.set(no, row);
        }
      }
      const byNo = (n)=>{
        const row = consolidatedByNo.get(n);
        if (!row) return null;
        return { name: row.constituency_name, district: row.district, reserved: row.reserved || 'General' };
      };

      return { partiesIdx, allianceColors, allianceOriginalColors, byNo, consolidated, consolidatedByNo };
    }

    function enrichParty(code, partiesIdx){
      const norm = normalizeParty(code||'');
      const meta = partiesIdx[norm] || partiesIdx[code] || null;
      return { code: norm || null, name: meta? meta.name : null, color: meta? meta.color : '#888' };
    }

    function renderYearBlock(year, rec, partiesIdx){
      if (!rec) return `<div class="card election-result"><h3 class="election-title">Bihar Elections ${year} Results</h3><div class="muted">Not available</div></div>`;
      const w = rec['Winner'] || {}; const ru = rec['Runner up'] || {};
      const wP = enrichParty(w.Party, partiesIdx); const ruP = enrichParty(ru.Party, partiesIdx);
      const wVotes = parseInt(String(w.Votes||'').replace(/,/g,''),10) || 0;
      const ruVotes = parseInt(String(ru.Votes||'').replace(/,/g,''),10) || 0;
      const margin = parseInt(String(rec.Margin||'').replace(/,/g,''),10) || Math.max(0, wVotes-ruVotes);
      const maxV = Math.max(wVotes, ruVotes, 1);
      const wPct = Math.round((wVotes/maxV)*100);
      const ruPct = Math.round((ruVotes/maxV)*100);
      
      const marginType = margin > 20000 ? 'Comfortable' : margin > 5000 ? 'Moderate' : 'Close';
      
      return `
        <div class="card election-result">
          <h3 class="election-title">Bihar Elections ${year} Results</h3>
          
          <div class="candidate-row">
            <div class="candidate-info">
              <div>
                <div class="candidate-name">WINNER: ${w.Candidate || '—'}</div>
                <div class="candidate-party">${wP.name || wP.code || '—'} • <span class="vote-count">${fmtNumber(wVotes)} votes</span></div>
              </div>
            </div>
            <div class="bar"><span style="width:${wPct}%; background:${wP.color}"></span></div>
          </div>
          
          <div class="candidate-row">
            <div class="candidate-info">
              <div>
                <div class="candidate-name">Runner-up: ${ru.Candidate || '—'}</div>
                <div class="candidate-party">${ruP.name || ruP.code || '—'} • <span class="vote-count">${fmtNumber(ruVotes)} votes</span></div>
              </div>
            </div>
            <div class="bar"><span style="width:${ruPct}%; background:${ruP.color}"></span></div>
          </div>
          
          <div class="margin-info">
            <span class="margin-text">MARGIN: ${fmtNumber(margin)} votes</span>
          </div>
        </div>`;
    }

    function computeTrend(r2010, r2015, r2020, r2025){
      const partyOf = (rec)=> normalizeParty((rec && rec['Winner'] && rec['Winner'].Party) || '');
      const nameOf = (rec)=> (rec && rec['Winner'] && rec['Winner'].Candidate) || null;
      const p10 = partyOf(r2010), p15 = partyOf(r2015), p20 = partyOf(r2020);
      const p25 = partyOf(r2025);
      const lines = [];
      if (p10 && p15){ lines.push(p10 === p15 ? `2010 → 2015: Hold by ${p15}` : `2010 → 2015: Gain from ${p10} to ${p15}`); }
      if (p15 && p20){ lines.push(p15 === p20 ? `2015 → 2020: Hold by ${p20}` : `2015 → 2020: Gain from ${p15} to ${p20}`); }
      const winners = [];
      if (r2010) winners.push(`2010: ${nameOf(r2010) || '—'} (${p10 || '—'})`);
      if (r2015) winners.push(`2015: ${nameOf(r2015) || '—'} (${p15 || '—'})`);
      if (r2020) winners.push(`2020: ${nameOf(r2020) || '-'} (${p20 || '-'})`);
      if (r2025) winners.push(`2025: ${nameOf(r2025) || '-'} (${p25 || '-'})`);
      return { lines, winners };
    }

    function renderEnhancedTrends(r2010, r2015, r2020, r2025, partiesIdx) {
      const partyOf = (rec) => normalizeParty((rec && rec['Winner'] && rec['Winner'].Party) || '');
      const nameOf = (rec) => (rec && rec['Winner'] && rec['Winner'].Candidate) || null;
      
      // Get all election years and their data
      const elections = [
        { year: '2010', rec: r2010, party: partyOf(r2010), name: nameOf(r2010) },
        { year: '2015', rec: r2015, party: partyOf(r2015), name: nameOf(r2015) },
        { year: '2020', rec: r2020, party: partyOf(r2020), name: nameOf(r2020) },
        { year: '2025', rec: r2025, party: partyOf(r2025), name: nameOf(r2025) }
      ].filter(e => e.rec);
      
      if (elections.length === 0) {
        return '<div class="trends-container"><div class="muted">No election data available</div></div>';
      }
      
      let timelineHTML = '';
      
      elections.forEach((election, index) => {
        const party = enrichParty(election.party, partiesIdx);
        
        // Year node
        timelineHTML += `
          <div class="timeline-year">
            <div class="timeline-year-badge">${election.year}</div>
            <div class="timeline-candidate">
              <div class="timeline-candidate-name">${election.name || '—'}</div>
              <div class="timeline-party" style="background: ${party.color}">${party.code || '—'}</div>
            </div>
          </div>`;
        
        // Connection (only if not the last item)
        if (index < elections.length - 1) {
          const nextElection = elections[index + 1];
          const isHold = election.party === nextElection.party;
          const changeClass = isHold ? 'timeline-hold' : 'timeline-gain';
          const changeText = isHold ? 'HOLD' : 'GAIN';
          
          timelineHTML += `
            <div class="timeline-connection">
              <div class="timeline-line"></div>
              <div class="timeline-change ${changeClass}">
                ${changeText}
              </div>
            </div>`;
        }
      });
      
      return `
        <div class="trends-container">
          <div class="timeline-scroll">
            <div class="timeline-container">
              ${timelineHTML}
            </div>
          </div>
          <div class="timeline-hint">← Timeline can be scrolled horizontally →</div>
        </div>`;
    }

    function renderSeat(seatNo, data){
      const base = data.byNo(seatNo);
      const out = document.getElementById('output');
      if (!base){ out.innerHTML = `<div class="error">Seat #${seatNo} not found.</div>`; return; }

      // Build per-year records from consolidated row (includes runner-up)
      function recFromConsolidated(row, year){
        if (!row) return null;
        const y = String(year);
        const wName = row[`y${y}_winner_name`];
        const wParty = row[`y${y}_winner_party`];
        const wVotes = row[`y${y}_winner_votes`];
        const ruName = row[`y${y}_runner_name`];
        const ruParty = row[`y${y}_runner_party`];
        const ruVotes = row[`y${y}_runner_votes`];
        const margin = row[`y${y}_margin`];
        if (!wName && !wParty && !wVotes && !margin) return null;
        return {
          'Winner': { Candidate: wName || '-', Party: wParty || '-', Votes: wVotes || '0' },
          'Runner up': { Candidate: ruName || '-', Party: ruParty || '-', Votes: ruVotes || '0' },
          'Margin': margin || '0',
        };
      }

      let r2010 = null, r2015 = null, r2020 = null, r2025 = null;
      let row = null;
      if (data && data.consolidatedByNo){
        row = data.consolidatedByNo.get(seatNo) || null;
        r2010 = recFromConsolidated(row, 2010);
        r2015 = recFromConsolidated(row, 2015);
        r2020 = recFromConsolidated(row, 2020);
        r2025 = recFromConsolidated(row, 2025);
      }

      const mla = row ? { mla: row.current_mla_name, party: row.current_mla_party, alliance: row.current_mla_alliance } : {};
      const mlaParty = enrichParty(mla.party, data.partiesIdx);
      const reserved = base.reserved ? base.reserved : 'General';
      const trend = computeTrend(r2010, r2015, r2020, r2025);

      // Determine announced mode automatically based on presence of 2025 data,
      // with optional override via URL param `announced=1|0`.
      let announced = !!r2025;
      try {
        const qp = new URLSearchParams(location.search);
        const force = (qp.get('announced') || '').trim();
        if (force === '1' || force.toLowerCase() === 'true') announced = true;
        if (force === '0' || force.toLowerCase() === 'false') announced = false;
      } catch {}
      const announcedToggle = document.getElementById('resultsToggle');
      if (announcedToggle) {
        announcedToggle.checked = announced;
        announcedToggle.disabled = true;
        announcedToggle.title = 'Auto-detected from data (override via ?announced=1|0)';
      }

      const headerHTML = `
        <div class="card constituency-header">
          <h2 class="constituency-title">${base.name} Assembly Election 2025</h2>
          <div class="constituency-info">
            <div><strong>District:</strong> ${base.district}</div>
            <div><strong>Seat Type:</strong> <span class="badge">${reserved}</span></div>
          </div>
        </div>

        ${announced ? '' : `
        <div class="card cms-content-card" id="cms-pre">
          <div class="cms-content-body">
            <div class="cms-placeholder">Loading…</div>
          </div>
        </div>`}
        
        ${announced ? renderYearBlock(2025, r2025, data.partiesIdx) : ''}

        ${announced ? `
        <div class=\"card cms-content-card\" id=\"cms-post\">\n          <div class=\"cms-content-body\">\n            <div class=\"cms-placeholder\">Loading…</div>\n          </div>\n        </div>` : ''}
        
        <div class="card cms-content-card">
          <div class="cms-content-body">
            <div id="mapEmbed" style="width:100%;"></div>
          </div>
        </div>
        
        ${announced ? '' : `
        <div class="card current-mla-card">
          <h3 class="current-mla-title">${base.name} Current MLA</h3>
          <p class="mla-name">${mla.mla ? mla.mla : '-'}</p>
          ${(() => { const parts=[]; if (mlaParty && (mlaParty.name || mlaParty.code)) parts.push(mlaParty.name || mlaParty.code); if (mla && mla.alliance) parts.push(`Alliance: ${mla.alliance}`); return parts.length ? `<p class=\"current-mla-meta\">${parts.join(' • ')}</p>` : '' })()}
        </div>`}
        
        <div class="card">
          <h3 class="past-results-title">Bihar Assembly Elections ${base.name} Past Results</h3>
          ${renderEnhancedTrends(r2010, r2015, r2020, (announced ? r2025 : null), data.partiesIdx)}
        </div>
        
        <div class="results-container">
          ${renderYearBlock(2020, r2020, data.partiesIdx)}
          ${renderYearBlock(2015, r2015, data.partiesIdx)}
          ${renderYearBlock(2010, r2010, data.partiesIdx)}
        </div>
        
        <div class="disclaimer-footer">
          <div class="disclaimer-text">
            This page incorporates information from Wikipedia articles, available under the Creative Commons Attribution-ShareAlike 4.0 License, and data from the Election Commission of India (ECI)
          </div>
        </div>`;

      out.innerHTML = headerHTML;
      // Update timeline scroll hint visibility: mobile always show; desktop show only for 4 years
      try {
        const isMobile = () => window.matchMedia && window.matchMedia('(max-width: 767px)').matches;
        const updateHint = (root)=>{
          const scroller = root.querySelector('.timeline-scroll');
          const hint = root.querySelector('.timeline-hint');
          if (!scroller || !hint) return;
          if (isMobile()) {
            hint.style.display = 'block';
            return;
          }
          const yearCount = scroller.querySelectorAll('.timeline-year').length;
          hint.style.display = (yearCount >= 4) ? 'block' : 'none';
        };
        document.querySelectorAll('.trends-container').forEach(tc=> updateHint(tc));
        if (!window.__timelineHintResizeBound) {
          window.__timelineHintResizeBound = true;
          window.addEventListener('resize', () => {
            document.querySelectorAll('.trends-container').forEach(tc=> updateHint(tc));
          });
        }
      } catch (_) {}
      // Mount map iframe: sandbox → dh-sandbox route; otherwise → GitHub Pages (with local fallback)
      try {
        const mountMap = async (num)=>{
          const el = document.getElementById('mapEmbed');
          if (!el) return;
          el.innerHTML = '';
          const ac = String(num).padStart(3,'0');
          const iframe = document.createElement('iframe');
          iframe.className = 'embed-map';
          iframe.loading = 'lazy';
          iframe.referrerPolicy = 'no-referrer';
          iframe.style.width = '100%';
          iframe.style.height = '600px';
          iframe.style.border = '0';
          iframe.style.borderRadius = '8px';
          const enable2025 = announced ? '1' : '0';
          const host = (location.hostname||'').toLowerCase();
          const isSandbox = host.includes('quintype.io') || host.includes('sandbox');
          const ghRemote = `https://suhastpml.github.io/Bihar_constituency_page/map.html?ac=${ac}&enable2025=${enable2025}`;
          const local = `./map.html?ac=${ac}&enable2025=${enable2025}`;
          let target = ghRemote;
          if (isSandbox) {
            const sandboxUrl = `https://dh-sandbox-web.quintype.io/biharmap?ac=${ac}&enable2025=${enable2025}`;
            try {
              const head = await fetch(sandboxUrl, { method: 'HEAD' });
              if (head && head.ok) target = sandboxUrl;
            } catch {}
          }
          let loaded = false;
          iframe.onload = ()=>{ loaded = true; };
          iframe.src = target;
          el.appendChild(iframe);
          if (target !== local) setTimeout(()=>{ if (!loaded) iframe.src = local; }, 3000);
        };
        // Fire-and-forget; do not await inside non-async scope
        mountMap(seatNo);
        // Inject hardcoded CMS content into pre/post blocks
        const injectCms = (id, html)=>{
          const el = document.getElementById(id);
          if (!el) return;
          const body = el.querySelector('.cms-content-body');
          if (!body) return;
          body.innerHTML = html;
        };
        if (!announced) injectCms('cms-pre', CMS_PRE_HTML);
        if (announced) injectCms('cms-post', CMS_POST_HTML);
        window.__lastRender = { seatNo, announced };
        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) exportBtn.disabled = false;
      } catch (_) {}
    }

    function buildEmbedHTML(state){
      const seatNo = state && state.seatNo;
      const announced = !!(state && state.announced);
      const ac = String(seatNo).padStart(3,'0');
      const enable2025 = announced ? '1' : '0';
      const output = document.getElementById('output');
      const clone = output ? output.cloneNode(true) : document.createElement('div');
      const map = clone.querySelector('#mapEmbed');
      if (map){
        const iframe = document.createElement('iframe');
        iframe.className = 'embed-map';
        iframe.loading = 'lazy';
        iframe.referrerPolicy = 'no-referrer';
        iframe.style.width = '100%';
        iframe.style.height = '600px';
        iframe.style.border = '0';
        iframe.style.borderRadius = '8px';
        iframe.src = `https://suhastpml.github.io/Bihar_constituency_page/map.html?ac=${ac}&enable2025=${enable2025}`;
        map.innerHTML = '';
        map.appendChild(iframe);
      }
      let titleText = 'Bihar Constituency';
      try {
        const t = clone.querySelector('.constituency-title');
        if (t && t.textContent) titleText = t.textContent.trim();
      } catch {}
      let styles = '';
      try { document.querySelectorAll('style').forEach(s=>{ styles += (s.textContent||'') + '\n'; }); } catch {}
      const headFonts = `
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Roboto+Serif:wght@400;500;600&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">`;
      const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  ${headFonts}
  <title>${titleText}</title>
  <style>${styles}</style>
</head>
<body>
  <div class="container">
    ${clone.innerHTML}
  </div>
</body>
</html>`;
      return html;
    }

    function buildScopedStylesForId(id){
      const ID = '#' + id;
      function scopeSelector(sel){
        let t = sel.trim();
        // Replace global roots with container id
        t = t.replace(/:root/g, ID);
        t = t.replace(/(^|\s)html(\b|\s|:)/g, `$1${ID}$2`);
        t = t.replace(/(^|\s)body(\b|\s|:)/g, `$1${ID}$2`);
        // Prefix if not already targeting the container
        if (!t.startsWith(ID)) t = ID + ' ' + t;
        return t;
      }
      function scopeRule(rule){
        try {
          const CSSRuleObj = window.CSSRule || {};
          const STYLE = CSSRuleObj.STYLE_RULE || 1;
          const MEDIA = CSSRuleObj.MEDIA_RULE || 4;
          const FONT = CSSRuleObj.FONT_FACE_RULE || 5;
          const SUPPORTS = CSSRuleObj.SUPPORTS_RULE || 12;
          const KEYFRAMES = CSSRuleObj.KEYFRAMES_RULE || 7;
          const KEYFRAME = CSSRuleObj.KEYFRAME_RULE || 8;
          switch (rule.type) {
            case STYLE: {
              const parts = (rule.selectorText || '').split(',');
              const scoped = parts.map(scopeSelector).join(', ');
              return scoped + ' {' + rule.style.cssText + '}';
            }
            case MEDIA: {
              let inner = '';
              for (let i=0; i<rule.cssRules.length; i++) inner += scopeRule(rule.cssRules[i]);
              return '@media ' + (rule.media && rule.media.mediaText || '') + '{' + inner + '}';
            }
            case FONT: {
              return rule.cssText;
            }
            case SUPPORTS: {
              let inner = '';
              for (let i=0; i<rule.cssRules.length; i++) inner += scopeRule(rule.cssRules[i]);
              return '@supports ' + (rule.conditionText || '') + '{' + inner + '}';
            }
            case KEYFRAMES: {
              // Keep keyframes as-is; names unlikely to collide
              return rule.cssText;
            }
            case KEYFRAME: {
              return rule.cssText;
            }
            default:
              return rule.cssText || '';
          }
        } catch(_) { return ''; }
      }
      let out = '';
      try {
        for (const sheet of Array.from(document.styleSheets)){
          if (!sheet.ownerNode || sheet.ownerNode.tagName !== 'STYLE') continue;
          const rules = sheet.cssRules || [];
          for (let i=0; i<rules.length; i++) out += scopeRule(rules[i]);
        }
      } catch(_) {}
      return out;
    }

    function buildDivOnlySnippet(state){
      const seatNo = state && state.seatNo;
      const announced = !!(state && state.announced);
      const ac = String(seatNo).padStart(3,'0');
      const enable2025 = announced ? '1' : '0';
      const output = document.getElementById('output');
      const clone = output ? output.cloneNode(true) : document.createElement('div');
      const map = clone.querySelector('#mapEmbed');
      if (map){
        const iframe = document.createElement('iframe');
        iframe.className = 'embed-map';
        iframe.loading = 'lazy';
        iframe.referrerPolicy = 'no-referrer';
        iframe.style.width = '100%';
        iframe.style.height = '600px';
        iframe.style.border = '0';
        iframe.style.borderRadius = '8px';
        iframe.src = `https://suhastpml.github.io/Bihar_constituency_page/map.html?ac=${ac}&enable2025=${enable2025}`;
        map.innerHTML = '';
        map.appendChild(iframe);
      }
      const hostId = `bihar-embed-${ac}`;
      const scopedStyles = buildScopedStylesForId(hostId);
      const snippet = `<div id="${hostId}">\n  <style>${scopedStyles}</style>\n  ${clone.innerHTML}\n</div>`;
      return snippet;
    }
    function buildInlineEmbedSnippet(state){
      const seatNo = state && state.seatNo;
      const announced = !!(state && state.announced);
      const ac = String(seatNo).padStart(3,'0');
      const enable2025 = announced ? '1' : '0';
      const output = document.getElementById('output');
      const clone = output ? output.cloneNode(true) : document.createElement('div');
      const map = clone.querySelector('#mapEmbed');
      if (map){
        const iframe = document.createElement('iframe');
        iframe.className = 'embed-map';
        iframe.loading = 'lazy';
        iframe.referrerPolicy = 'no-referrer';
        iframe.style.width = '100%';
        iframe.style.height = '600px';
        iframe.style.border = '0';
        iframe.style.borderRadius = '8px';
        iframe.src = `https://suhastpml.github.io/Bihar_constituency_page/map.html?ac=${ac}&enable2025=${enable2025}`;
        map.innerHTML = '';
        map.appendChild(iframe);
      }
      // Inline styles, but scope CSS vars to shadow host
      let styles = '';
      try {
        document.querySelectorAll('style').forEach(s=>{ styles += (s.textContent||'') + '\n'; });
        styles = styles.replace(/:root/g, ':host');
        styles = styles.replace(/\bhtml\b/g, ':host');
        styles = styles.replace(/\bbody\b/g, ':host');
      } catch {}
      const hostId = `bihar-embed-${ac}`;
      const snippet = `<div id="${hostId}"></div>\n<script>(function(){\n  try {\n    var host = document.getElementById('${hostId}'); if (!host) return;\n    var shadow = host.attachShadow({ mode: 'open' });\n    var styleEl = document.createElement('style');\n    styleEl.textContent = ${JSON.stringify(styles)};\n    shadow.appendChild(styleEl);\n    var wrap = document.createElement('div');\n    wrap.className = 'container';\n    wrap.innerHTML = ${JSON.stringify(clone.innerHTML)};\n    shadow.appendChild(wrap);\n  } catch(e) { console && console.error && console.error(e); }\n})();<\/script>`;
      return snippet;
    }

    function escapeForAttr(str){
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('"', '&quot;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;');
    }

    function buildIframeSrcdocSnippet(state){
      const html = buildEmbedHTML(state);
      const srcdoc = escapeForAttr(html);
      // Fixed height is safer without postMessage auto-resize; adjust as needed
      const snippet = `<iframe 
  title="Bihar Constituency"
  loading="lazy"
  referrerpolicy="no-referrer"
  style="width:100%; max-width:1120px; height:1100px; border:0; border-radius:8px;"
  srcdoc="${srcdoc}"></iframe>`;
      return snippet;
    }

    async function exportEmbed(){
      try {
        const state = window.__lastRender;
        if (!state || !state.seatNo){
          alert('Load a constituency first.');
          return;
        }
        const ac = String(state.seatNo).padStart(3,'0');
        const snippet = buildDivOnlySnippet(state);
        try {
          await navigator.clipboard.writeText(snippet);
          const status = document.getElementById('status');
          if (status) status.textContent = `Copied DIV-only embed snippet for AC ${ac} to clipboard`;
        } catch (e){
          // Fallback prompt copy
          const ok = window.prompt('Copy the embed code below:', snippet);
          const status = document.getElementById('status');
          if (status) status.textContent = ok !== null ? `Embed snippet ready to copy for AC ${ac}` : `Copy cancelled`;
        }
      } catch (e){ console.error(e); alert('Failed to copy embed code'); }
    }

    (async function init(){
      try {
        // Default data source toggle based on host/query
        (function setDefaultSource(){
          const sourceT = document.getElementById('sourceToggle');
          const qp = new URLSearchParams(location.search);
          const hostIsGh = (location.hostname || '').toLowerCase().includes('github.io');
          let useLocalDefault = hostIsGh ? true : false;
          const qps = qp.get('source');
          if (qps === 'gh' || qps === 'local') useLocalDefault = true;
          if (qps === 'sandbox') useLocalDefault = false;
          if (sourceT) sourceT.checked = useLocalDefault;
        })();
        const data = await loadAll();
        const input = document.getElementById('seatNo');
        const btn = document.getElementById('loadBtn');
        const toggle = document.getElementById('resultsToggle');
        const exportBtn = document.getElementById('exportBtn');
        const go = ()=>{
          const val = parseInt(input.value,10);
          if (!Number.isFinite(val) || val < 1 || val > 243){
            document.getElementById('output').innerHTML = '<div class="error">Enter a valid constituency number (1â€“243)</div>';
            return;
          }
          renderSeat(val, data);
        };
        btn.addEventListener('click', go);
        input.addEventListener('keydown', (e)=>{ if (e.key==='Enter') go(); });
        // Toggle is auto-managed and disabled; retain handler if enabled via dev override.
        if (toggle) toggle.addEventListener('change', go);
        if (exportBtn) exportBtn.addEventListener('click', exportEmbed);
        const sourceTNow = document.getElementById('sourceToggle');
        if (sourceTNow) sourceTNow.addEventListener('change', ()=>{
          const sp = new URLSearchParams(location.search);
          sp.set('source', sourceTNow.checked ? 'gh' : 'sandbox');
          location.search = sp.toString();
        });
      } catch (e){
        document.getElementById('status').textContent = 'Failed to load data';
        document.getElementById('output').innerHTML = '<div class="error">Error loading files. If opened directly as file://, please serve over http:// with a local server.</div>';
        console.error(e);
      }
    })();
  </script>
</body>
</html>


