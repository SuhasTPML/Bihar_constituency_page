<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bihar Assembly | Constituency Viewer</title>
  <style>
    :root {
      --bg: #f7f7f9; --card: #fff; --text: #222; --muted: #666; --border: #e5e7eb; --accent: #0f766e;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    header { margin-bottom: 16px; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    .controls { display: flex; gap: 8px; align-items: center; margin: 8px 0 16px; }
    input[type="number"] { padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; width: 160px; }
    button { padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; background: #fff; cursor: pointer; }
    button.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,.06); margin-bottom: 12px; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .col { flex: 1 1 300px; }
    .muted { color: var(--muted); }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef2ff; border: 1px solid #e5e7eb; font-size: 12px; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; color: #fff; font-size: 12px; }
    .kv { display: grid; grid-template-columns: 140px 1fr; gap: 6px 12px; }
    .section-title { font-weight: 600; margin: 0 0 8px; }
    .vote-bars { margin-top: 8px; }
    .bar { height: 8px; border-radius: 999px; background: #e5e7eb; position: relative; margin-bottom: 6px; }
    .bar > span { position: absolute; left: 0; top: 0; bottom: 0; border-radius: 999px; }
    .bar-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .hr { height: 1px; background: var(--border); margin: 12px 0; }
    .note { font-size: 12px; color: var(--muted); }
    .error { color: #b91c1c; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Bihar Assembly — Constituency Viewer</h1>
      <div class="controls">
        <label for="seatNo">Constituency No:</label>
        <input id="seatNo" type="number" min="1" max="243" placeholder="e.g. 21" />
        <button id="loadBtn" class="primary">Load</button>
        <span id="status" class="muted"></span>
      </div>
      <div class="note">Tip: Serve this file over a local web server to allow fetching local JSON (e.g., <span class="mono">python -m http.server</span> and open http://localhost:8000/constituency_viewer.html).</div>
    </header>

    <div id="output"></div>
  </div>

  <script>
    const FILES = {
      constituencies: './bihar_constituencies.json',
      parties: './parties.json',
      results2010: './2010_results.json',
      results2015: './2015_results.json',
      results2020: './2020_results.json',
      mla: './mla_current.csv',
    };

    const PARTY_NORMALIZE = new Map([
      ['JDU','JD(U)'], ['JD(U)','JD(U)'], ['CPM','CPI(M)'], ['HAM','HAM(S)'], ['Ind','IND'], ['IND','IND']
    ]);

    const fmtNumber = (n) => (n==null? '—' : n.toLocaleString('en-IN'));

    function normalizeParty(code){ if(!code) return code; const c = code.trim(); return PARTY_NORMALIZE.get(c) || c; }

    function parseCSV(text){
      // Robust-enough CSV parser supporting quoted fields and commas
      const rows = [];
      let i=0, field='', row=[], inQ=false; 
      function pushField(){ row.push(field); field=''; }
      function pushRow(){ rows.push(row); row=[]; }
      while(i<text.length){
        const ch = text[i];
        if (inQ){
          if (ch==='"' && text[i+1]==='"'){ field+='"'; i+=2; continue; }
          if (ch==='"'){ inQ=false; i++; continue; }
          field+=ch; i++; continue;
        } else {
          if (ch==='"'){ inQ=true; i++; continue; }
          if (ch===','){ pushField(); i++; continue; }
          if (ch==='\n'){ pushField(); pushRow(); i++; continue; }
          if (ch==='\r'){ i++; continue; }
          field+=ch; i++; continue;
        }
      }
      if (field.length>0 || row.length>0) { pushField(); pushRow(); }
      // Header map
      const header = rows.shift() || [];
      return rows.filter(r=>r.length>0 && r.some(c=>c.trim()!=='')).map(r=>{
        const o={}; header.forEach((h,idx)=>{ o[h]=r[idx]; }); return o;
      });
    }

    async function loadAll(){
      const status = document.getElementById('status');
      status.textContent = 'Loading data…';
      const [constRes, partiesRes, r10Res, r15Res, r20Res, mlaRes] = await Promise.all([
        fetch(FILES.constituencies),
        fetch(FILES.parties),
        fetch(FILES.results2010),
        fetch(FILES.results2015),
        fetch(FILES.results2020),
        fetch(FILES.mla)
      ]);
      const [constituencies, parties, r2010, r2015, r2020, mlaText] = await Promise.all([
        constRes.json(), partiesRes.json(), r10Res.json(), r15Res.json(), r20Res.json(), mlaRes.text()
      ]);
      status.textContent = 'Data loaded';

      // Indexes
      const partiesIdx = {}; (parties||[]).forEach(p=> partiesIdx[p.code]=p);
      const byNo = (n)=> constituencies[String(n)] || null;

      function resultByNo(resultsObj, no){
        if (!resultsObj) return null;
        const key = String(no);
        for (const district of Object.keys(resultsObj)){
          const arr = resultsObj[district];
          if (!Array.isArray(arr)) continue;
          for (const rec of arr){ if (String(rec['#'])===key) return rec; }
        }
        return null;
      }

      const mlaRows = parseCSV(mlaText);
      const mlaIdx = {};
      for (const row of mlaRows){
        const no = parseInt((row.no||'').trim(),10); if (!Number.isFinite(no)) continue;
        mlaIdx[no] = row;
      }

      return { partiesIdx, byNo, r2010, r2015, r2020, mlaIdx };
    }

    function enrichParty(code, partiesIdx){
      const norm = normalizeParty(code||'');
      const meta = partiesIdx[norm] || partiesIdx[code] || null;
      return { code: norm || null, name: meta? meta.name : null, color: meta? meta.color : '#888' };
    }

    function renderYearBlock(year, rec, partiesIdx){
      if (!rec) return `<div class="card"><div class="section-title">${year} Result</div><div class="muted">Not available</div></div>`;
      const w = rec['Winner'] || {}; const ru = rec['Runner up'] || {};
      const wP = enrichParty(w.Party, partiesIdx); const ruP = enrichParty(ru.Party, partiesIdx);
      const wVotes = parseInt(String(w.Votes||'').replace(/,/g,''),10) || 0;
      const ruVotes = parseInt(String(ru.Votes||'').replace(/,/g,''),10) || 0;
      const margin = parseInt(String(rec.Margin||'').replace(/,/g,''),10) || Math.max(0, wVotes-ruVotes);
      const maxV = Math.max(wVotes, ruVotes, 1);
      const wPct = Math.round((wVotes/maxV)*100);
      const ruPct = Math.round((ruVotes/maxV)*100);
      return `
        <div class="card">
          <div class="section-title">${year} Result</div>
          <div>
            <div><strong>Winner:</strong> ${w.Candidate || '—'} — ${wP.name || wP.code || '—'} <span class="mono">| Votes: ${fmtNumber(wVotes)}</span></div>
            <div><strong>Runner-up:</strong> ${ru.Candidate || '—'} — ${ruP.name || ruP.code || '—'} <span class="mono">| Votes: ${fmtNumber(ruVotes)}</span></div>
            <div><strong>Margin:</strong> <span class="mono">${fmtNumber(margin)}</span> votes</div>
            <div class="vote-bars">
              <div class="bar-label"><span>${w.Candidate || '—'}</span><span class="mono">${fmtNumber(wVotes)}</span></div>
              <div class="bar"><span style="width:${wPct}%; background:${wP.color}"></span></div>
              <div class="bar-label"><span>${ru.Candidate || '—'}</span><span class="mono">${fmtNumber(ruVotes)}</span></div>
              <div class="bar"><span style="width:${ruPct}%; background:${ruP.color}"></span></div>
            </div>
          </div>
        </div>`;
    }

    function computeTrend(r2010, r2015, r2020){
      const partyOf = (rec)=> normalizeParty((rec && rec['Winner'] && rec['Winner'].Party) || '');
      const nameOf = (rec)=> (rec && rec['Winner'] && rec['Winner'].Candidate) || null;
      const p10 = partyOf(r2010), p15 = partyOf(r2015), p20 = partyOf(r2020);
      const lines = [];
      if (p10 && p15){ lines.push(p10 === p15 ? `2010 → 2015: Hold by ${p15}` : `2010 → 2015: Gain from ${p10} to ${p15}`); }
      if (p15 && p20){ lines.push(p15 === p20 ? `2015 → 2020: Hold by ${p20}` : `2015 → 2020: Gain from ${p15} to ${p20}`); }
      const winners = [];
      if (r2010) winners.push(`2010: ${nameOf(r2010) || '—'} (${p10 || '—'})`);
      if (r2015) winners.push(`2015: ${nameOf(r2015) || '—'} (${p15 || '—'})`);
      if (r2020) winners.push(`2020: ${nameOf(r2020) || '—'} (${p20 || '—'})`);
      return { lines, winners };
    }

    function renderSeat(seatNo, data){
      const base = data.byNo(seatNo);
      const out = document.getElementById('output');
      if (!base){ out.innerHTML = `<div class="error">Seat #${seatNo} not found.</div>`; return; }

      const r2010 = (data.r2010? (function(){ return (function(results){
        const key = String(seatNo); for (const d of Object.keys(results)){ const arr = results[d]; if (!Array.isArray(arr)) continue; for (const rec of arr){ if (String(rec['#'])===key) return rec; } } return null; })(data.r2010); })() : null);
      const r2015 = (data.r2015? (function(){ return (function(results){
        const key = String(seatNo); for (const d of Object.keys(results)){ const arr = results[d]; if (!Array.isArray(arr)) continue; for (const rec of arr){ if (String(rec['#'])===key) return rec; } } return null; })(data.r2015); })() : null);
      const r2020 = (data.r2020? (function(){ return (function(results){
        const key = String(seatNo); for (const d of Object.keys(results)){ const arr = results[d]; if (!Array.isArray(arr)) continue; for (const rec of arr){ if (String(rec['#'])===key) return rec; } } return null; })(data.r2020); })() : null);

      const mla = data.mlaIdx[seatNo] || {};
      const mlaParty = enrichParty(mla.party, data.partiesIdx);
      const reserved = base.reserved ? base.reserved : 'General';
      const trend = computeTrend(r2010, r2015, r2020);

      const headerHTML = `
        <div class="card">
          <div class="row">
            <div class="col">
              <div class="section-title" style="font-size:18px;">${seatNo}. ${base.name} <span class="badge">${reserved}</span></div>
              <div class="kv">
                <div class="muted">District</div><div>${base.district}</div>
                <div class="muted">URL Slug</div><div class="mono">/bihar/constituency/${base.slug}</div>
              </div>
            </div>
            <div class="col">
              <div class="section-title">Current MLA</div>
              <div>${mla.mla ? mla.mla : '—'} — ${mlaParty.name || mlaParty.code || '—'} ${mla.alliance? '['+mla.alliance+']':''}
                ${mlaParty.code? `<span class="pill" style="background:${mlaParty.color}; margin-left:6px;">${mlaParty.code}</span>`:''}
              </div>
            </div>
          </div>
          <div class="hr"></div>
          <div class="row">
            <div class="col">${renderYearBlock(2020, r2020, data.partiesIdx)}</div>
            <div class="col">${renderYearBlock(2015, r2015, data.partiesIdx)}</div>
          </div>
          <div class="row">
            <div class="col">${renderYearBlock(2010, r2010, data.partiesIdx)}</div>
            <div class="col">
              <div class="card">
                <div class="section-title">Trend & Notes</div>
                <div>
                  ${trend && trend.lines.length ? trend.lines.map(l => `<div>${l}</div>`).join('') : '—'}
                </div>
                <div class="muted" style="margin-top:8px;">${trend && trend.winners.length ? trend.winners.join(' • ') : ''}</div>
                <div class="note" style="margin-top:8px;">No percentages or electors displayed (not available in current data).</div>
              </div>
            </div>
          </div>
        </div>`;

      out.innerHTML = headerHTML;
    }

    (async function init(){
      try {
        const data = await loadAll();
        const input = document.getElementById('seatNo');
        const btn = document.getElementById('loadBtn');
        const go = ()=>{
          const val = parseInt(input.value,10);
          if (!Number.isFinite(val) || val < 1 || val > 243){
            document.getElementById('output').innerHTML = '<div class="error">Enter a valid constituency number (1–243)</div>';
            return;
          }
          renderSeat(val, data);
        };
        btn.addEventListener('click', go);
        input.addEventListener('keydown', (e)=>{ if (e.key==='Enter') go(); });
      } catch (e){
        document.getElementById('status').textContent = 'Failed to load data';
        document.getElementById('output').innerHTML = '<div class="error">Error loading files. If opened directly as file://, please serve over http:// with a local server.</div>';
        console.error(e);
      }
    })();
  </script>
</body>
</html>
