<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bihar Assembly | Constituency Viewer</title>
  <style>
    :root {
      --bg: #f7f7f9; --card: #fff; --text: #222; --muted: #666; --border: #e5e7eb; --accent: #0091ac;
      --primary: #0091ac; --primary-dark: #007a93; --header-bg: #0091ac; --header-text: #fff;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 980px; margin: 0 auto; padding: 0 16px; }
    
    /* Header Styles */
    .main-header { display: none !important; }
    .header-content { max-width: 980px; margin: 0 auto; padding: 0 16px; display: flex; justify-content: space-between; align-items: center; }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .header-right { display: flex; align-items: center; gap: 16px; }
    .menu-icon, .search-icon, .account-icon { cursor: pointer; font-size: 18px; }
    .site-title { font-size: 18px; font-weight: 600; margin: 0; letter-spacing: 0.5px; }
    
    /* Search Section */
    .search-section { padding: 24px 0 16px; }
    .search-controls { display: flex; gap: 12px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
    .search-controls label { font-weight: 500; color: var(--text); }
    input[type="number"] { padding: 12px 16px; border: 1px solid var(--border); border-radius: 8px; width: 180px; font-size: 16px; }
    input[type="number"]:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(0, 145, 172, 0.1); }
    .primary-btn { padding: 12px 20px; border: none; border-radius: 8px; background: var(--primary); color: #fff; cursor: pointer; font-size: 16px; font-weight: 500; }
    .primary-btn:hover { background: var(--primary-dark); }
    .status-text { color: var(--muted); font-size: 14px; }
    /* Mobile-first Card Layout */
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,.08); margin-bottom: 16px; }
    .constituency-header { margin-bottom: 24px; }
    .constituency-title { font-size: 24px; font-weight: 700; margin: 0 0 8px; color: var(--text); }
    .constituency-info { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
    .current-mla-card { margin-bottom: 16px; }
    .current-mla-title { font-size: 16px; font-weight: 600; margin: 0 0 12px; letter-spacing: 0.5px; }
    .mla-name { font-size: 20px; font-weight: 600; margin: 0 0 4px; }
    .mla-party { color: var(--muted); font-size: 16px; }
    .mla-alliance { color: var(--muted); font-size: 16px; margin-top: 2px; }
    
    /* CMS Content Placeholder */
    .cms-content-card { margin-bottom: 16px; }
    .cms-content-title { font-size: 16px; font-weight: 600; margin: 0 0 12px; letter-spacing: 0.5px; color: var(--text); }
    .cms-content-body { color: var(--text); line-height: 1.6; font-size: 15px; }
    .cms-placeholder { color: var(--muted); font-style: italic; background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px dashed var(--border); }
    
    /* Mobile-first: Stack everything vertically */
    .results-container { display: flex; flex-direction: column; gap: 16px; }
    .muted { color: var(--muted); }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef2ff; border: 1px solid #e5e7eb; font-size: 12px; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; color: #fff; font-size: 12px; }
    .kv { display: grid; grid-template-columns: 140px 1fr; gap: 6px 12px; }
    .section-title { font-weight: 600; margin: 0 0 8px; }
    .vote-bars { margin-top: 8px; }
    .bar { height: 8px; border-radius: 999px; background: #e5e7eb; position: relative; margin-bottom: 6px; }
    .bar > span { position: absolute; left: 0; top: 0; bottom: 0; border-radius: 999px; }
    .bar-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .hr { height: 1px; background: var(--border); margin: 12px 0; }
    .note { font-size: 12px; color: var(--muted); }
    .error { color: #b91c1c; }
    
    /* Data Source Disclaimer Footer */
    .disclaimer-footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
      text-align: center;
    }
    .disclaimer-text {
      color: var(--muted);
      font-size: 11px;
      line-height: 1.4;
      font-weight: 400;
    }
    
    /* Horizontal Timeline */
    .trends-container { margin: 20px 0; }
    .timeline-scroll {
      overflow-x: auto;
      padding: 20px 0;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }
    .timeline-container {
      display: flex;
      align-items: center;
      min-width: max-content;
      padding: 0 20px;
      gap: 0;
      position: relative;
    }
    .timeline-year {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      min-width: 120px;
      padding: 0 10px;
    }
    .timeline-year-badge {
      background: var(--primary);
      color: white;
      font-weight: 700;
      font-size: 16px;
      padding: 8px 16px;
      border-radius: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 145, 172, 0.3);
      position: relative;
      z-index: 2;
    }
    .timeline-candidate {
      text-align: center;
      margin-bottom: 8px;
    }
    .timeline-candidate-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--text);
      margin-bottom: 4px;
    }
    .timeline-party {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      color: white;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    .timeline-connection {
      display: flex;
      align-items: center;
      flex-direction: column;
      min-width: 100px;
      position: relative;
    }
    .timeline-line {
      width: 60px;
      height: 3px;
      background: var(--border);
      position: relative;
      margin: 10px 0;
    }
    .timeline-line::before {
      content: '';
      position: absolute;
      top: 50%;
      right: -4px;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid var(--border);
      border-top: 4px solid transparent;
      border-bottom: 4px solid transparent;
    }
    .timeline-change {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 8px;
    }
    .timeline-hold {
      background: #dcfce7;
      color: #16a34a;
    }
    .timeline-gain {
      background: #fef3c7;
      color: #d97706;
    }
    .timeline-hint {
      display: none; /* Hidden by default on desktop */
      text-align: center;
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
      margin-bottom: 4px;
      font-style: italic;
    }

    /* Election Result Cards */
    .election-result { margin-bottom: 16px; }
    .election-title { font-size: 16px; font-weight: 600; margin: 0 0 16px; letter-spacing: 0.5px; color: var(--text); }
    .candidate-row { margin-bottom: 16px; }
    .candidate-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .candidate-name { font-weight: 600; font-size: 16px; }
    .candidate-party { color: var(--muted); font-size: 14px; }
    .vote-count { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-weight: 600; }
    .margin-info { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
    .margin-text { font-weight: 600; }
    
    /* Mobile Timeline Optimizations */
    @media (max-width: 767px) {
      .timeline-scroll {
        padding: 16px 0;
        scroll-snap-type: x mandatory;
      }
      .timeline-container {
        padding: 0 16px;
      }
      .timeline-year {
        min-width: 100px;
        padding: 0 8px;
        scroll-snap-align: center;
      }
      .timeline-year-badge {
        font-size: 14px;
        padding: 6px 12px;
        margin-bottom: 12px;
      }
      .timeline-candidate-name {
        font-size: 12px;
      }
      .timeline-party {
        font-size: 11px;
        padding: 3px 8px;
      }
      .timeline-connection {
        min-width: 80px;
      }
      .timeline-line {
        width: 50px;
      }
      .timeline-change {
        font-size: 10px;
        padding: 3px 6px;
      }
      .timeline-hint {
        display: block; /* Show on mobile */
      }
    }

    /* Responsive Breakpoints */
    @media (min-width: 768px) {
      .container { padding: 0 24px; }
      .search-controls { gap: 16px; }
      .results-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
      .constituency-title { font-size: 28px; }
    }
    
    @media (min-width: 1024px) {
      .results-container { grid-template-columns: 1fr 1fr 1fr; }
      .header-content { padding: 0 24px; }
      .constituency-title { font-size: 32px; }
    }
  </style>
</head>
<body>
  <header class="main-header">
    <div class="header-content">
      <div class="header-left">
        <span class="menu-icon">☰</span>
        <h1 class="site-title">BIHAR ASSEMBLY</h1>
      </div>
      <div class="header-right">
        <span class="search-icon">🔍</span>
        <span class="account-icon">👤</span>
      </div>
    </div>
  </header>
  
  <div class="container">
    <div class="search-section">
      <div class="search-controls">
        <label for="seatNo">Constituency No:</label>
        <input id="seatNo" type="number" min="1" max="243" placeholder="e.g. 21" />
        <button id="loadBtn" class="primary-btn">Load</button>
        <label style="margin-left:12px; display:flex; align-items:center; gap:6px;">
          <input id="resultsToggle" type="checkbox" />
          <span>Results announced</span>
        </label>
        <label style="margin-left:12px; display:flex; align-items:center; gap:6px;">
          <input id="sourceToggle" type="checkbox" />
          <span>Use GitHub Pages data</span>
        </label>
      </div>
      <span id="status" class="status-text"></span>
      <div class="note">Tip: Serve this file over a local web server to allow fetching local JSON (e.g., <span class="mono">python -m http.server</span> and open http://localhost:8000/constituency_viewer.html).</div>
    </div>

    <div id="output"></div>
    <div class="note" style="margin-top:12px;">
      This page incorporates information from Wikipedia articles, available under the Creative Commons Attribution-ShareAlike 4.0 License
    </div>
  </div>

  <script>
    // Inline CMS content blocks (hardcoded)
    const CMS_PRE_HTML = `
      <p>The Bihar Assembly elections are underway. Follow this page for constituency-wise context, key candidates, and background ahead of the 2025 results. We’ll update this section with quick takeaways as trends emerge.</p>
      <p>Note: Past results and party colors are based on publicly available records. Turn the ‘Results announced’ toggle on when official 2025 results are declared to see updated summaries.</p>
    `;
    const CMS_POST_HTML = `
      <p>The 2025 results for this constituency are in. The summary and margin details are displayed above. Use this section for quick context on how the outcome compares with 2010–2020 and what it means for the broader alliances.</p>
      <p>Data sources include official ECI releases and curated archives. We will refine the summary as more granular booth-level data is published.</p>
    `;
    function getFiles(useLocal){
      if (useLocal){
        return {
          parties: './parties.json',
          resultsConsolidated: './bihar_election_results_consolidated.json',
        };
      }
      return {
        parties: 'https://dh-sandbox-web.quintype.io/parties.json',
        resultsConsolidated: 'https://dh-sandbox-web.quintype.io/bihar_election_results_consolidated',
      };
    }

    const PARTY_NORMALIZE = new Map([
      ['JDU','JD(U)'], ['JD(U)','JD(U)'], ['CPM','CPI(M)'], ['HAM','HAM(S)'], ['Ind','IND'], ['IND','IND']
    ]);

    const fmtNumber = (n) => (n==null? 'N/A' : Number(n).toLocaleString('en-IN'));

    function normalizeParty(code){ if(!code) return code; const c = code.trim(); return PARTY_NORMALIZE.get(c) || c; }

    function parseCSV(text){
      // Robust-enough CSV parser supporting quoted fields and commas
      const rows = [];
      let i=0, field='', row=[], inQ=false; 
      function pushField(){ row.push(field); field=''; }
      function pushRow(){ rows.push(row); row=[]; }
      while(i<text.length){
        const ch = text[i];
        if (inQ){
          if (ch==='"' && text[i+1]==='"'){ field+='"'; i+=2; continue; }
          if (ch==='"'){ inQ=false; i++; continue; }
          field+=ch; i++; continue;
        } else {
          if (ch==='"'){ inQ=true; i++; continue; }
          if (ch===','){ pushField(); i++; continue; }
          if (ch==='\n'){ pushField(); pushRow(); i++; continue; }
          if (ch==='\r'){ i++; continue; }
          field+=ch; i++; continue;
        }
      }
      if (field.length>0 || row.length>0) { pushField(); pushRow(); }
      // Header map
      const header = rows.shift() || [];
      return rows.filter(r=>r.length>0 && r.some(c=>c.trim()!=='')).map(r=>{
        const o={}; header.forEach((h,idx)=>{ o[h]=r[idx]; }); return o;
      });
    }

    async function loadAll(){
      const status = document.getElementById('status');
      status.textContent = 'Loading data...';
      const useLocal = !!(document.getElementById('sourceToggle') && document.getElementById('sourceToggle').checked);
      const FILES = getFiles(useLocal);
      const [partiesRes, consolidatedRes] = await Promise.all([
        fetch(FILES.parties),
        fetch(FILES.resultsConsolidated)
      ]);
      const [parties, consolidated] = await Promise.all([
        partiesRes.json(), consolidatedRes.json()
      ]);
      status.textContent = 'Data loaded';

      // Indexes
      const partiesIdx = {}; (parties||[]).forEach(p=> partiesIdx[p.code]=p);
      // Index consolidated by seat number
      const consolidatedByNo = new Map();
      if (Array.isArray(consolidated)){
        for (const row of consolidated){
          const no = parseInt(String(row.no||''),10);
          if (Number.isFinite(no)) consolidatedByNo.set(no, row);
        }
      }
      const byNo = (n)=>{
        const row = consolidatedByNo.get(n);
        if (!row) return null;
        return { name: row.constituency_name, district: row.district, reserved: row.reserved || 'General' };
      };

      return { partiesIdx, byNo, consolidated, consolidatedByNo };
    }

    function enrichParty(code, partiesIdx){
      const norm = normalizeParty(code||'');
      const meta = partiesIdx[norm] || partiesIdx[code] || null;
      return { code: norm || null, name: meta? meta.name : null, color: meta? meta.color : '#888' };
    }

    function renderYearBlock(year, rec, partiesIdx){
      if (!rec) return `<div class="card election-result"><h3 class="election-title">Bihar Elections ${year} Results</h3><div class="muted">Not available</div></div>`;
      const w = rec['Winner'] || {}; const ru = rec['Runner up'] || {};
      const wP = enrichParty(w.Party, partiesIdx); const ruP = enrichParty(ru.Party, partiesIdx);
      const wVotes = parseInt(String(w.Votes||'').replace(/,/g,''),10) || 0;
      const ruVotes = parseInt(String(ru.Votes||'').replace(/,/g,''),10) || 0;
      const margin = parseInt(String(rec.Margin||'').replace(/,/g,''),10) || Math.max(0, wVotes-ruVotes);
      const maxV = Math.max(wVotes, ruVotes, 1);
      const wPct = Math.round((wVotes/maxV)*100);
      const ruPct = Math.round((ruVotes/maxV)*100);
      
      const marginType = margin > 20000 ? 'Comfortable' : margin > 5000 ? 'Moderate' : 'Close';
      
      return `
        <div class="card election-result">
          <h3 class="election-title">Bihar Elections ${year} Results</h3>
          
          <div class="candidate-row">
            <div class="candidate-info">
              <div>
                <div class="candidate-name">WINNER: ${w.Candidate || '—'}</div>
                <div class="candidate-party">${wP.name || wP.code || '—'} • <span class="vote-count">${fmtNumber(wVotes)} votes</span></div>
              </div>
            </div>
            <div class="bar"><span style="width:${wPct}%; background:${wP.color}"></span></div>
          </div>
          
          <div class="candidate-row">
            <div class="candidate-info">
              <div>
                <div class="candidate-name">Runner-up: ${ru.Candidate || '—'}</div>
                <div class="candidate-party">${ruP.name || ruP.code || '—'} • <span class="vote-count">${fmtNumber(ruVotes)} votes</span></div>
              </div>
            </div>
            <div class="bar"><span style="width:${ruPct}%; background:${ruP.color}"></span></div>
          </div>
          
          <div class="margin-info">
            <span class="margin-text">MARGIN: ${fmtNumber(margin)} votes</span>
          </div>
        </div>`;
    }

    function computeTrend(r2010, r2015, r2020, r2025){
      const partyOf = (rec)=> normalizeParty((rec && rec['Winner'] && rec['Winner'].Party) || '');
      const nameOf = (rec)=> (rec && rec['Winner'] && rec['Winner'].Candidate) || null;
      const p10 = partyOf(r2010), p15 = partyOf(r2015), p20 = partyOf(r2020);
      const p25 = partyOf(r2025);
      const lines = [];
      if (p10 && p15){ lines.push(p10 === p15 ? `2010 → 2015: Hold by ${p15}` : `2010 → 2015: Gain from ${p10} to ${p15}`); }
      if (p15 && p20){ lines.push(p15 === p20 ? `2015 → 2020: Hold by ${p20}` : `2015 → 2020: Gain from ${p15} to ${p20}`); }
      const winners = [];
      if (r2010) winners.push(`2010: ${nameOf(r2010) || '—'} (${p10 || '—'})`);
      if (r2015) winners.push(`2015: ${nameOf(r2015) || '—'} (${p15 || '—'})`);
      if (r2020) winners.push(`2020: ${nameOf(r2020) || '-'} (${p20 || '-'})`);
      if (r2025) winners.push(`2025: ${nameOf(r2025) || '-'} (${p25 || '-'})`);
      return { lines, winners };
    }

    function renderEnhancedTrends(r2010, r2015, r2020, r2025, partiesIdx) {
      const partyOf = (rec) => normalizeParty((rec && rec['Winner'] && rec['Winner'].Party) || '');
      const nameOf = (rec) => (rec && rec['Winner'] && rec['Winner'].Candidate) || null;
      
      // Get all election years and their data
      const elections = [
        { year: '2010', rec: r2010, party: partyOf(r2010), name: nameOf(r2010) },
        { year: '2015', rec: r2015, party: partyOf(r2015), name: nameOf(r2015) },
        { year: '2020', rec: r2020, party: partyOf(r2020), name: nameOf(r2020) },
        { year: '2025', rec: r2025, party: partyOf(r2025), name: nameOf(r2025) }
      ].filter(e => e.rec);
      
      if (elections.length === 0) {
        return '<div class="trends-container"><div class="muted">No election data available</div></div>';
      }
      
      let timelineHTML = '';
      
      elections.forEach((election, index) => {
        const party = enrichParty(election.party, partiesIdx);
        
        // Year node
        timelineHTML += `
          <div class="timeline-year">
            <div class="timeline-year-badge">${election.year}</div>
            <div class="timeline-candidate">
              <div class="timeline-candidate-name">${election.name || '—'}</div>
              <div class="timeline-party" style="background: ${party.color}">${party.code || '—'}</div>
            </div>
          </div>`;
        
        // Connection (only if not the last item)
        if (index < elections.length - 1) {
          const nextElection = elections[index + 1];
          const isHold = election.party === nextElection.party;
          const changeClass = isHold ? 'timeline-hold' : 'timeline-gain';
          const changeText = isHold ? 'HOLD' : 'GAIN';
          
          timelineHTML += `
            <div class="timeline-connection">
              <div class="timeline-line"></div>
              <div class="timeline-change ${changeClass}">
                ${changeText}
              </div>
            </div>`;
        }
      });
      
      return `
        <div class="trends-container">
          <div class="timeline-scroll">
            <div class="timeline-container">
              ${timelineHTML}
            </div>
          </div>
          <div class="timeline-hint">← Timeline can be scrolled horizontally →</div>
        </div>`;
    }

    function renderSeat(seatNo, data){
      const base = data.byNo(seatNo);
      const out = document.getElementById('output');
      if (!base){ out.innerHTML = `<div class="error">Seat #${seatNo} not found.</div>`; return; }

      // Build per-year records from consolidated row (includes runner-up)
      function recFromConsolidated(row, year){
        if (!row) return null;
        const y = String(year);
        const wName = row[`y${y}_winner_name`];
        const wParty = row[`y${y}_winner_party`];
        const wVotes = row[`y${y}_winner_votes`];
        const ruName = row[`y${y}_runner_name`];
        const ruParty = row[`y${y}_runner_party`];
        const ruVotes = row[`y${y}_runner_votes`];
        const margin = row[`y${y}_margin`];
        if (!wName && !wParty && !wVotes && !margin) return null;
        return {
          'Winner': { Candidate: wName || '-', Party: wParty || '-', Votes: wVotes || '0' },
          'Runner up': { Candidate: ruName || '-', Party: ruParty || '-', Votes: ruVotes || '0' },
          'Margin': margin || '0',
        };
      }

      let r2010 = null, r2015 = null, r2020 = null, r2025 = null;
      let row = null;
      if (data && data.consolidatedByNo){
        row = data.consolidatedByNo.get(seatNo) || null;
        r2010 = recFromConsolidated(row, 2010);
        r2015 = recFromConsolidated(row, 2015);
        r2020 = recFromConsolidated(row, 2020);
        r2025 = recFromConsolidated(row, 2025);
      }

      const mla = row ? { mla: row.current_mla_name, party: row.current_mla_party, alliance: row.current_mla_alliance } : {};
      const mlaParty = enrichParty(mla.party, data.partiesIdx);
      const reserved = base.reserved ? base.reserved : 'General';
      const trend = computeTrend(r2010, r2015, r2020, r2025);

      const announced = !!(document.getElementById('resultsToggle') && document.getElementById('resultsToggle').checked);

      const headerHTML = `
        <div class="card constituency-header">
          <h2 class="constituency-title">${base.name} Assembly Election 2025</h2>
          <div class="constituency-info">
            <div><strong>District:</strong> ${base.district}</div>
            <div><strong>Seat Type:</strong> <span class="badge">${reserved}</span></div>
          </div>
        </div>

        ${announced ? '' : `
        <div class="card cms-content-card" id="cms-pre">
          <div class="cms-content-body">
            <div class="cms-placeholder">Loading…</div>
          </div>
        </div>`}
        
        ${announced ? renderYearBlock(2025, r2025, data.partiesIdx) : ''}

        ${announced ? `
        <div class=\"card cms-content-card\" id=\"cms-post\">\n          <div class=\"cms-content-body\">\n            <div class=\"cms-placeholder\">Loading…</div>\n          </div>\n        </div>` : ''}
        
        <div class="card cms-content-card">
          <div class="cms-content-body">
            <div id="mapEmbed" style="width:100%;"></div>
            
          </div>
        </div>
        
        ${announced ? '' : `
        <div class="card current-mla-card">
          <h3 class="current-mla-title">${base.name} Current MLA</h3>
          <div class="mla-name">${mla.mla ? mla.mla : '-'}</div>
          <div class="mla-party">${mlaParty.name || mlaParty.code || '-'}
            ${mlaParty.code? `<span class=\"pill\" style=\"background:${mlaParty.color}; margin-left:6px;\">${mlaParty.code}</span>`:''}
          </div>
          <div class="mla-alliance">Alliance: <span class="badge">${mla.alliance || '-'}</span></div>
        </div>`}
        
        <div class="card">
          <h3 class="current-mla-title">Bihar Assembly elections ${base.name} Past Results</h3>
          ${renderEnhancedTrends(r2010, r2015, r2020, (announced ? r2025 : null), data.partiesIdx)}
        </div>
        
        <div class="results-container">
          ${renderYearBlock(2020, r2020, data.partiesIdx)}
          ${renderYearBlock(2015, r2015, data.partiesIdx)}
          ${renderYearBlock(2010, r2010, data.partiesIdx)}
        </div>
        
        <div class="disclaimer-footer">
          <div class="disclaimer-text">
            This page incorporates information from Wikipedia articles, available under the Creative Commons Attribution-ShareAlike 4.0 License, and data from the Election Commission of India (ECI)
          </div>
        </div>`;

      out.innerHTML = headerHTML;
      // Mount map iframe with remote first and local fallback
      try {
        const mountMap = (num)=>{
          const el = document.getElementById('mapEmbed');
          if (!el) return;
          el.innerHTML = '';
          const ac = String(num).padStart(3,'0');
          const iframe = document.createElement('iframe');
          iframe.className = 'embed-map';
          iframe.loading = 'lazy';
          iframe.referrerPolicy = 'no-referrer';
          iframe.style.width = '100%';
          iframe.style.height = '600px';
          iframe.style.border = '0';
          iframe.style.borderRadius = '8px';
          const enable2025 = announced ? '1' : '0';
          const remote = `https://suhastpml.github.io/Bihar_constituency_page/map.html?ac=${ac}&enable2025=${enable2025}`;
          const local = `./map.html?ac=${ac}&enable2025=${enable2025}`;
          let loaded = false;
          iframe.onload = ()=>{ loaded = true; };
          iframe.src = remote;
          el.appendChild(iframe);
          setTimeout(()=>{ if (!loaded) iframe.src = local; }, 3000);
        };
        mountMap(seatNo);
        // Inject hardcoded CMS content into pre/post blocks
        const injectCms = (id, html)=>{
          const el = document.getElementById(id);
          if (!el) return;
          const body = el.querySelector('.cms-content-body');
          if (!body) return;
          body.innerHTML = html;
        };
        if (!announced) injectCms('cms-pre', CMS_PRE_HTML);
        if (announced) injectCms('cms-post', CMS_POST_HTML);
      } catch (_) {}
    }

    (async function init(){
      try {
        // Default data source toggle based on host/query
        (function setDefaultSource(){
          const sourceT = document.getElementById('sourceToggle');
          const qp = new URLSearchParams(location.search);
          const hostIsGh = (location.hostname || '').toLowerCase().includes('github.io');
          let useLocalDefault = hostIsGh ? true : false;
          const qps = qp.get('source');
          if (qps === 'gh' || qps === 'local') useLocalDefault = true;
          if (qps === 'sandbox') useLocalDefault = false;
          if (sourceT) sourceT.checked = useLocalDefault;
        })();
        const data = await loadAll();
        const input = document.getElementById('seatNo');
        const btn = document.getElementById('loadBtn');
        const toggle = document.getElementById('resultsToggle');
        const go = ()=>{
          const val = parseInt(input.value,10);
          if (!Number.isFinite(val) || val < 1 || val > 243){
            document.getElementById('output').innerHTML = '<div class="error">Enter a valid constituency number (1â€“243)</div>';
            return;
          }
          renderSeat(val, data);
        };
        btn.addEventListener('click', go);
        input.addEventListener('keydown', (e)=>{ if (e.key==='Enter') go(); });
        if (toggle) toggle.addEventListener('change', go);
        const sourceTNow = document.getElementById('sourceToggle');
        if (sourceTNow) sourceTNow.addEventListener('change', ()=>{
          const sp = new URLSearchParams(location.search);
          sp.set('source', sourceTNow.checked ? 'gh' : 'sandbox');
          location.search = sp.toString();
        });
      } catch (e){
        document.getElementById('status').textContent = 'Failed to load data';
        document.getElementById('output').innerHTML = '<div class="error">Error loading files. If opened directly as file://, please serve over http:// with a local server.</div>';
        console.error(e);
      }
    })();
  </script>
</body>
</html>


